@page "/students"

@using Syncfusion.Blazor.ImageEditor
@using My.ClasStars.Models
@using System.IO
@using My.ClasStars.Components

@if (_contacts == null)
{
    <p><em>@StringsResource.Students_Loading</em></p>
}
else
{
    <button @onclick="testToast">test toast</button>
    @if (ShowPageOverlay)
    {
        <div class="page-overlay">
            <div class="page-overlay__spinner spinner-border text-primary" role="status"></div>
            <div class="page-overlay__text">Working on it...</div>
        </div>
    }

    <div class="pictureManage">
        <div class="leftPnl @((!HomePage.IsAdmin) ? "w-50 fit-content" : "")">
            <div class="">
                <div class="input-group cardSearch">
                    <input type="text"
                           class="form-control"
                           @bind="@value"
                           @oninput="@(ui => { value = (string)ui.Value; })"
                           id="txtsearch"
                           placeholder="@StringsResource.Students_SearchPlaceholder"
                           aria-label="@StringsResource.Students_SearchPlaceholder"
                           aria-describedby="button-addon2">
                    <div class="position-relative">
                        <button class="inputSrchBTN p-0" @onclick="GetFilterList">
                            <i class="fa fa-search" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>

                <div class="contact-filters mt-2">
                    <label class="me-3">
                        <input type="checkbox"
                               @bind="filterWithImage"
                               @bind:event="onchange"
                               @bind:after="ApplyFilters" />
                        @StringsResource.Students_FilterWithImage
                    </label>

                    <label>
                        <input type="checkbox"
                               @bind="filterWithoutImage"
                               @bind:event="onchange"
                               @bind:after="ApplyFilters" />
                        @StringsResource.Students_FilterWithoutImage
                    </label>
                </div>
            </div>

            <div class="d-flex align-items-center justify-content-between mt-2">
                <div class="student-filter-status text-muted small">
                    @if (_isStudentListFiltered)
                    {
                        <span>Showing matches for <strong>@_activeFilterLabel</strong></span>
                    }
                    else
                    {
                        <span>Showing all students</span>
                    }
                </div>
                <button class="btn btn-link btn-sm p-0" @onclick="ClearStudentFilter">Clear filter</button>
            </div>

            <div class="cstUserLists">
                @foreach (ContactInfoModel student in _displayContactModels)
                {
                    <div id="@student.ContactID"
                         @ondragover="DragOver"
                         @ondragover:preventDefault="true"
                         @ondrop="@(async e => await DragDrop(e, student))"
                         @onmousedown="() => FilterList(student.FirstName + ' ' + student.LastName)"
                         @onclick="() => OnStudentClicked(student)">
                        <div class="e-card e-avatar-showcase cstEcard">
                            <div id="element" class="avatar-sub-block">
                                <span>
                                    <span>@student.FileAs</span>
                                    @if (!string.IsNullOrWhiteSpace(student.PersonID))
                                    {
                                        <br />
                                        <b>@StringsResource.StudentList_PersonID:</b>
                                        <span class="font-weight-400">@student.PersonID</span>
                                    }
                                </span>

                                @if (student.ContactPicture == null)
                                {
                                    <span class="e-avatar e-avatar-xlarge e-avatar-circle blue no-select"
                                          @ondblclick="() => LoadContact(student)"
                                          @onclick:stopPropagation>
                                        @student.Initials
                                    </span>
                                }
                                else
                                {
                                    <div class="e-avatar e-avatar-circle e-avatar-xlarge"
                                         @onclick:stopPropagation>
                                        @{
                                            var imgg = $"data:image/png;base64,{Convert.ToBase64String(student.ContactPicture)}";
                                        }
                                        <img src="@imgg"
                                             alt="@StringsResource.Students_ProfilePictureAlt"
                                             @ondblclick="@(async () => await LoadContact(student))" />
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        @if (HomePage.IsAdmin)
        {
            <div class="rightPnl @ShowHide">
                <div class="inputRight">
                    <!-- File Name Format block -->
                    <div class="file-name-format shadow-sm">
                        <div class="file-name-format__header">
                            <div class="file-name-format__title">
                                <div class="file-name-format__icon">
                                    <i class="fa fa-tag" aria-hidden="true"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">Picture Name Format</div>
                                    <div class="text-muted small">@GetCurrentFormatPreview()</div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <div class="form-check form-switch m-0">
                                    <input type="checkbox"
                                           class="form-check-input"
                                           id="looseMatch"
                                           @bind="enableLooseMatching"
                                           @bind:event="onchange"
                                           @bind:after="(() => EvaluateImageMatches())" />
                                    <label class="form-check-label" for="looseMatch">Loose name matching</label>
                                </div>

                                <button type="button"
                                        class="btn btn-sm btn-outline-primary"
                                        @onclick="() => isFormatPopupVisible = true">
                                    <i class="fa fa-pencil me-1" aria-hidden="true"></i>
                                    Edit format
                                </button>
                            </div>
                        </div>
                        <p class="mb-0 text-muted small">
                            Control how image file names are interpreted when finding student matches.
                        </p>
                    </div>

                    <div class="file-input-zone">
                        <InputFile class="input_selectpicture"
                                   OnChange="LoadFiles"
                                   multiple
                                   accept=".jpg,.jpeg,.png" />
                        <InputFile OnChange="LoadFiles"
                                   accept=".jpg,.jpeg,.png"
                                   @ref="fileInputSingle"
                                   hidden />
                        <span>@StringsResource.HP_SelectPictures</span>
                    </div>

                    <div class="editorIcons upDown-icon spaceEven">
                        <div class=" e-avatar e-avatar-circle e-avatar-large @refreshClass">
                            @{
                                int itemCount = (from c in ImageURI where c.IsVis == true select c).ToList().Count;
                                if (ImageURI.Count > 0 && itemCount <= ImageURI.Count)
                                {
                                    refreshClass = "enablerImg";
                                }
                                else
                                {
                                    refreshClass = "disableImg";
                                }
                            }
                            <img src="@refreshPath"
                                 @onclick="All"
                                 title="@StringsResource.Students_Status_ReloadAll" />
                        </div>
                    </div>
                </div>

                <div class="inputImages" id="imageContainer" @onmousedown="All">
                    @if (!isProcessingFiles)
                    {
                        var visibleList = ImageURI.Where(c => c.IsVis).ToList();
                        if (visibleList.Count > 0)
                        {
                            foreach (var ss in visibleList)
                            {
                                if (!string.IsNullOrWhiteSpace(ss.ImageUrl))
                                {
                                    <div class="img-card @(ss.IsMatched ? "img-card-matched" : "")"
                                         @onclick="() => OnImageClicked(ss)">
                                        @if (ss.IsMatched)
                                        {
                                            <button type="button"
                                                    class="match-indicator"
                                                    title="View matched student"
                                                    @onclick="(e => OnMatchIconClicked(ss))"
                                                    @onclick:stopPropagation>
                                                <i class="fa fa-check-circle" aria-hidden="true"></i>
                                            </button>
                                        }

                                        <img class="img-item @(ss.IsSqu.HasValue && ss.IsSqu.Value ? "imgGreen" : "imgRed")"
                                             src="@ss.ImageUrl"
                                             @ondblclick="() => LoadImage(ss)"
                                             @onclick:stopPropagation
                                             draggable="true"
                                             @ondragstart="@(e => DragStart(e, ss))"
                                             loading="lazy" />

                                        <div class="inputImages-label">
                                            @Path.GetFileNameWithoutExtension(ss.ImageName)
                                        </div>
                                    </div>
                                }
                            }
                        }
                        else
                        {
                            <div class="empty-state">@StringsResource.Students_NoImages</div>
                        }
                    }
                    else
                    {
                        <div class="loader">@StringsResource.Students_LoadingImages</div>
                    }
                </div>
            </div>
        }
    </div>

    <ImageEditorModal @ref="editorModal"
                      ImageURI="@ImageURI"
                      ImageURIChanged="@OnImageUriChanged"
                      ContactPictureUpdated="@OnContactPictureUpdated"
                      @bind-Visible="isEditorVisible" />

    <!-- File Name Format Popup -->
    @if (isFormatPopupVisible)
    {
        <div class="modal-backdrop-custom">
            <div class="modal-dialog-custom format-modal">
                <div class="format-modal__header">
                    <div>
                        <h5 class="mb-1">File Name Format</h5>
                        <p class="text-muted mb-0">Tell ClasStars how to read names from your picture files.</p>
                    </div>
                    <span class="badge bg-light text-primary">Example: @GetCurrentFormatExample()</span>
                </div>

                <div class="format-modal__grid">
                    <div class="format-modal__card">
                        <div class="small text-muted mb-1">First piece (required)</div>
                        <InputSelect @bind-Value="formatPart1">
                            <option value="@FileNamePart.PersonId">PersonID</option>
                            <option value="@FileNamePart.FirstName">FirstName</option>
                            <option value="@FileNamePart.LastName">LastName</option>
                        </InputSelect>
                        <p class="hint">This is the strongest identifier and should appear first.</p>
                    </div>
                    <div class="format-modal__card">
                        <div class="small text-muted mb-1">Second piece</div>
                        <InputSelect @bind-Value="formatPart2">
                            <option value="@FileNamePart.None">None</option>
                            <option value="@FileNamePart.PersonId">PersonID</option>
                            <option value="@FileNamePart.FirstName">FirstName</option>
                            <option value="@FileNamePart.LastName">LastName</option>
                        </InputSelect>
                        <p class="hint">Optional — helps when multiple students share an ID or name.</p>
                    </div>
                    <div class="format-modal__card">
                        <div class="small text-muted mb-1">Everything else</div>
                        <InputSelect @bind-Value="formatPart3">
                            <option value="@FileNamePart.None">None</option>
                            <option value="@FileNamePart.PersonId">PersonID</option>
                            <option value="@FileNamePart.FirstName">FirstName</option>
                            <option value="@FileNamePart.LastName">LastName</option>
                        </InputSelect>
                        <p class="hint">Use this when filenames contain a suffix such as a homeroom.</p>
                    </div>
                </div>

                <div class="d-flex justify-content-end mt-3 gap-2">
                    <button class="btn btn-outline-secondary btn-sm"
                            @onclick="() => isFormatPopupVisible = false">
                        Cancel
                    </button>
                    <button class="btn btn-primary btn-sm"
                            @onclick="SaveFileNameFormat">
                        Save format
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Assign Profile Picture Popup -->
    @if (isAssignPopupVisible && _selectedContactForAssign != null && _selectedImageForAssign != null)
    {
        <div class="modal-backdrop-custom">
            <div class="modal-dialog-custom assign-modal">
                <div class="assign-modal__header">
                    <div>
                        <p class="text-muted small mb-1">Update profile picture</p>
                        <h5 class="mb-0">@_selectedContactForAssign.PersonID - @_selectedContactForAssign.FileAs</h5>
                    </div>
                    <span class="badge bg-success">Matches found: @_matchedImagesForAssign.Count</span>
                </div>

                @if (_matchedImagesForAssign.Count > 1)
                {
                    <div class="alert alert-info py-2 px-3 small">
                        Multiple photos match this student. Pick the one you want to save.
                    </div>
                }

                <div class="assign-options">
                    @foreach (var option in _matchedImagesForAssign)
                    {
                        <label class="assign-option">
                            <input type="radio"
                                   name="assignChoice"
                                   value="@option.ImgId"
                                   checked="@(_selectedMatchOptionId == option.ImgId)"
                                   @onchange="() => OnMatchOptionSelected(option.ImgId)" />
                            <div class="assign-option__preview">
                                <img src="@option.ImageUrl" alt="Matched photo preview" loading="lazy" />
                            </div>
                            <div class="assign-option__meta">
                                <div class="fw-semibold text-truncate">@Path.GetFileName(option.ImageName)</div>
                                <small class="text-muted">Square crop required: @(option.IsSqu == true ? "Ready" : "Crop needed")</small>
                            </div>
                        </label>
                    }
                </div>

                <div class="d-flex justify-content-end gap-2 mt-3">
                    <button class="btn btn-outline-secondary btn-sm"
                            @onclick="CancelAssign">
                        Cancel
                    </button>
                    <button class="btn btn-primary btn-sm"
                            @onclick="ConfirmAssign"
                            disabled="@(_selectedImageForAssign == null)">
                        Save selection
                    </button>
                </div>
            </div>
        </div>
    }
}