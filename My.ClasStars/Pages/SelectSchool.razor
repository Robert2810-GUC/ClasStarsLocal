@page "/selectSchool"
@inject NavigationManager navManager
@inject SchoolListService SchoolListService
@inject ILogger<SelectSchool> Logger
@using My.ClasStars.Resources

<div class="col-12 pb-2">
    <div>
        <img src="Images/ClasStars Wide.svg" alt="logo" class="img-fluid select-school-logo">
    </div>
</div>

@if (SchoolListService.SchoolList == null)
{
    <p>Loading...</p>
}
else if (SchoolListService.SchoolList.Count == 0)
{
    <p>No schools available.</p>
}
else
{
    <div class="text-center">
        <div class="frm-logo ">
            <span>Welcome to ClasStars</span>
        </div>
        <div class="container borderdiv">
            <p class="button text-center user-email">@SchoolListService.Email</p>
            <p class="selection-copy">Please select a school</p>
            @foreach (var school in SchoolListService.SchoolList)
            {
                var logo = GetLogoDataUri(school.Logo);
                <button class="button" @onclick="() => HandleSchoolSelection(school)">
                    <div class="row ml-0 align-items-center">
                        <span>@school.Name</span>
                        @if (!string.IsNullOrEmpty(logo))
                        {
                            <div class="image-container mr-4">
                                <img src="@logo" alt="School logo" class="school-logo" />
                            </div>
                        }
                    </div>
                </button>
            }
        </div>
    </div>
}

@code {
    protected override void OnInitialized()
    {
        if (string.IsNullOrWhiteSpace(SchoolListService.Email))
        {
            Logger?.LogWarning("SelectSchool loaded without user context; redirecting to login.");
            navManager.NavigateTo("/", true);
        }
    }

    private void HandleSchoolSelection(SharedTypes.RegisteredOrganizationInfo school)
    {
        SchoolListService.NavDisplay = true;
        SchoolListService.SelectedSchool = school;
        SchoolListService.Initialized = false;
        navManager.NavigateTo("/homePage");
    }

    private string? GetLogoDataUri(byte[]? logoBytes)
    {
        if (logoBytes == null || logoBytes.Length == 0)
        {
            return null;
        }

        return $"data:image/jpeg;base64,{Convert.ToBase64String(logoBytes)}";
    }
}
