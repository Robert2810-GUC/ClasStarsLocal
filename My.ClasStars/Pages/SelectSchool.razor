@page "/selectSchool"
@inject NavigationManager navManager
@inject SchoolListService SchoolListService
@inject ILogger<SelectSchool> Logger
@using My.ClasStars.Resources
@using Microsoft.Extensions.Logging

<div class="col-12 pb-2">
    <div>
        <img style="width: 8%;" src="Images/ClasStars Wide.svg" alt="logo" class="img-fluid">
    </div>
    <div>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(initializationError))
{
    <div class="alert alert-danger" role="alert">@initializationError</div>
}
else if (SchoolListService.SchoolList == null)
{
    <p>@StringsResource.SelectSchool_Loading</p>
}
else if (SchoolListService.SchoolList.Count == 0)
{
    <p>@StringsResource.SelectSchool_None</p>
}
else
{

    <div class="text-center">
        <div class="frm-logo ">
            <span>@StringsResource.WelcomeClasstar</span>
        </div>
        <div class="container borderdiv">

            <p class="button text-center neutral-pill">@SchoolListService.Email</p>
            <p class="pt-3">@StringsResource.SelectSchool_SelectPrompt</p>
            @foreach (var school in SchoolListService.SchoolList)
            {
                if (school.Logo != null)
                {
                    string imageBase64 = Convert.ToBase64String(school.Logo);
                    string imageSrc = $"data:image/jpeg;base64,{imageBase64}";
                    <button class="button" @onclick="() => HandleSchoolSelection(school)">
                        <div class="row ml-0">
                            @school.Name
                            <div class="image-container mr-4">
                                <img style="height:40px;margin-top:-8px;" src="@imageSrc" alt="Image" />
                            </div>
                        </div>
                    </button>
                }
                else
                {
                    <button class="button" @onclick="() => HandleSchoolSelection(school)">@school.Name</button>
                }
            }
        </div>
    </div>
}

@code {

    private string? initializationError;

    protected override void OnInitialized()
    {
        try
        {
            if (SchoolListService.Email == null)
            {
                initializationError = StringsResource.UserNotFound;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialize select school page.");
            initializationError = StringsResource.SelectSchool_LoadFailed;
        }
    }
    private void HandleSchoolSelection(SharedTypes.RegisteredOrganizationInfo school)
    {
        SchoolListService.NavDisplay = true;
        SchoolListService.SelectedSchool = school;
        SchoolListService.Initialized = false;
        navManager.NavigateTo("/homePage");
    }
}