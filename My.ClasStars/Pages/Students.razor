@page "/students"

@using Syncfusion.Blazor.ImageEditor
@using My.ClasStars.Models
@using System.IO
@using My.ClasStars.Components

@if (_contacts == null)
{
    <p><em>@StringsResource.Students_Loading</em></p>
}
else
{
    @if (ShowPageOverlay)
    {
        <div class="page-overlay">
            <div class="page-overlay__spinner spinner-border text-primary" role="status"></div>
            <div class="page-overlay__text">Working on it...</div>
        </div>
    }

    <div class="pictureManage">
        <div class="leftPnl @((!HomePage.IsAdmin) ? "w-50 fit-content" : "")">
            <div class="">
                <div class="input-group cardSearch">
                    <input type="text"
                           class="form-control"
                           @bind="@value"
                           @oninput="@(ui => { value = (string)ui.Value; })"
                           id="txtsearch"
                           placeholder="@StringsResource.Students_SearchPlaceholder"
                           aria-label="@StringsResource.Students_SearchPlaceholder"
                           aria-describedby="button-addon2">
                    <div class="position-relative">
                        <button class="inputSrchBTN p-0" @onclick="GetFilterList">
                            <i class="fa fa-search" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>

                <div class="contact-filters mt-2">
                    <label class="me-3">
                        <input type="checkbox"
                               @bind="filterWithImage"
                               @bind:event="onchange"
                               @bind:after="ApplyFilters" />
                        @StringsResource.Students_FilterWithImage
                    </label>

                    <label>
                        <input type="checkbox"
                               @bind="filterWithoutImage"
                               @bind:event="onchange"
                               @bind:after="ApplyFilters" />
                        @StringsResource.Students_FilterWithoutImage
                    </label>
                </div>
            </div>

            <div class="d-flex align-items-center justify-content-between mt-2">
                <div class="student-filter-status text-muted small">
                    @if (_isStudentListFiltered)
                    {
                        <span>Showing matches for <strong>@_activeFilterLabel</strong></span>
                    }
                    else
                    {
                        <span>Showing all students</span>
                    }
                </div>
                <button class="btn btn-link btn-sm p-0" @onclick="ClearStudentFilter">Clear filter</button>
            </div>

            <div class="cstUserLists">
                @foreach (ContactInfoModel student in _displayContactModels)
                {
                    <div id="@student.ContactID"
                         @ondragover="DragOver"
                         @ondragover:preventDefault="true"
                         @ondrop="@(async e => await DragDrop(e, student))"
                         @onmousedown="() => FilterList(student.FirstName + ' ' + student.LastName)"
                         @onclick="() => OnStudentClicked(student)">
                        <div class="e-card e-avatar-showcase cstEcard">
                            <div id="element" class="avatar-sub-block">
                                <span>
                                    <span>@student.FileAs</span>
                                    @if (!string.IsNullOrWhiteSpace(student.PersonID))
                                    {
                                        <br />
                                        <b>@StringsResource.StudentList_PersonID:</b>
                                        <span class="font-weight-400">@student.PersonID</span>
                                    }
                                </span>

                                @if (student.ContactPicture == null)
                                {
                                    <span class="e-avatar e-avatar-xlarge e-avatar-circle blue no-select"
                                          @ondblclick="() => LoadContact(student)"
                                          @onclick:stopPropagation>
                                        @student.Initials
                                    </span>
                                }
                                else
                                {
                                    <div class="e-avatar e-avatar-circle e-avatar-xlarge"
                                         @onclick:stopPropagation>
                                        @{
                                            var imgg = $"data:image/png;base64,{Convert.ToBase64String(student.ContactPicture)}";
                                        }
                                        <img src="@imgg"
                                             alt="@StringsResource.Students_ProfilePictureAlt"
                                             @ondblclick="@(async () => await LoadContact(student))" />
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        @if (HomePage.IsAdmin)
        {
            <div class="rightPnl @ShowHide">
                <div class="inputRight">
                    <!-- File Name Format block -->
                    <div class="file-name-format d-flex align-items-center flex-wrap mb-2">
                        <div class="me-3">
                            <strong>Picture Name Format</strong><br />
                            <small class="text-muted">@GetCurrentFormatPreview()</small>
                        </div>
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary ms-2"
                                @onclick="() => isFormatPopupVisible = true">
                            Edit
                        </button>
                        <div class="form-check ms-3">
                            <input type="checkbox"
                                   class="form-check-input"
                                   id="looseMatch"
                                   @bind="enableLooseMatching"
                                   @bind:event="onchange"
                                   @bind:after="(() => EvaluateImageMatches())" />
                            <label class="form-check-label" for="looseMatch">Loose name matching</label>
                        </div>
                    </div>

                    <div class="file-input-zone">
                        <InputFile class="input_selectpicture"
                                   OnChange="LoadFiles"
                                   multiple
                                   accept=".jpg,.jpeg,.png" />
                        <InputFile OnChange="LoadFiles"
                                   accept=".jpg,.jpeg,.png"
                                   @ref="fileInputSingle"
                                   hidden />
                        <span>@StringsResource.HP_SelectPictures</span>
                    </div>

                    <div class="editorIcons upDown-icon spaceEven">
                        <div class=" e-avatar e-avatar-circle e-avatar-large @refreshClass">
                            @{
                                int itemCount = (from c in ImageURI where c.IsVis == true select c).ToList().Count;
                                if (ImageURI.Count > 0 && itemCount <= ImageURI.Count)
                                {
                                    refreshClass = "enablerImg";
                                }
                                else
                                {
                                    refreshClass = "disableImg";
                                }
                            }
                            <img src="@refreshPath"
                                 @onclick="All"
                                 title="@StringsResource.Students_Status_ReloadAll" />
                        </div>
                    </div>
                </div>

                <div class="inputImages" id="imageContainer" @onmousedown="All">
                    @if (!isProcessingFiles)
                    {
                        var visibleList = ImageURI.Where(c => c.IsVis).ToList();
                        if (visibleList.Count > 0)
                        {
                            foreach (var ss in visibleList)
                            {
                                if (!string.IsNullOrWhiteSpace(ss.ImageUrl))
                                {
                                    <div class="img-card @(ss.IsMatched ? "img-card-matched" : "")"
                                         @onclick="() => OnImageClicked(ss)">
                                        <img class="img-item @(ss.IsSqu.HasValue && ss.IsSqu.Value ? "imgGreen" : "imgRed")"
                                             src="@ss.ImageUrl"
                                             @ondblclick="() => LoadImage(ss)"
                                             @onclick:stopPropagation
                                             draggable="true"
                                             @ondragstart="@(e => DragStart(e, ss))"
                                             loading="lazy" />

                                        <div class="inputImages-label">
                                            @Path.GetFileNameWithoutExtension(ss.ImageName)
                                            @if (ss.IsMatched)
                                            {
                                                <span class="badge bg-success ms-1">Matched</span>
                                            }
                                        </div>
                                    </div>
                                }
                            }
                        }
                        else
                        {
                            <div class="empty-state">@StringsResource.Students_NoImages</div>
                        }
                    }
                    else
                    {
                        <div class="loader">@StringsResource.Students_LoadingImages</div>
                    }
                </div>
            </div>
        }
    </div>

    <ImageEditorModal @ref="editorModal"
                      ImageURI="@ImageURI"
                      ImageURIChanged="@OnImageUriChanged"
                      ContactPictureUpdated="@OnContactPictureUpdated"
                      @bind-Visible="isEditorVisible" />

    <!-- File Name Format Popup -->
    @if (isFormatPopupVisible)
    {
        <div class="modal-backdrop-custom">
            <div class="modal-dialog-custom">
                <h5>File Name Format</h5>

                <p class="small text-muted mb-1">
                    Choose how to detect student info from image file names.
                </p>
                <p class="small fw-bold">Current example: <span class="text-primary">@GetCurrentFormatExample()</span></p>

                <div class="row mb-2">
                    <div class="col-4">
                        <label>Part 1 (required)</label>
                        <InputSelect @bind-Value="formatPart1">
                            <option value="@FileNamePart.PersonId">PersonID</option>
                            <option value="@FileNamePart.FirstName">FirstName</option>
                            <option value="@FileNamePart.LastName">LastName</option>
                        </InputSelect>
                    </div>
                    <div class="col-4">
                        <label>Part 2</label>
                        <InputSelect @bind-Value="formatPart2">
                            <option value="@FileNamePart.None">None</option>
                            <option value="@FileNamePart.PersonId">PersonID</option>
                            <option value="@FileNamePart.FirstName">FirstName</option>
                            <option value="@FileNamePart.LastName">LastName</option>
                        </InputSelect>
                    </div>
                    <div class="col-4">
                        <label>Part 3</label>
                        <InputSelect @bind-Value="formatPart3">
                            <option value="@FileNamePart.None">None</option>
                            <option value="@FileNamePart.PersonId">PersonID</option>
                            <option value="@FileNamePart.FirstName">FirstName</option>
                            <option value="@FileNamePart.LastName">LastName</option>
                        </InputSelect>
                    </div>
                </div>

                <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-secondary btn-sm me-2"
                            @onclick="() => isFormatPopupVisible = false">
                        Cancel
                    </button>
                    <button class="btn btn-primary btn-sm"
                            @onclick="SaveFileNameFormat">
                        Save
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Assign Profile Picture Popup -->
    @if (isAssignPopupVisible && _selectedContactForAssign != null && _selectedImageForAssign != null)
    {
        <div class="modal-backdrop-custom">
            <div class="modal-dialog-custom">
                <h5>Assign Profile Picture</h5>

                <p>
                    This image will be used as the profile picture for:<br />
                    <strong>@_selectedContactForAssign.PersonID - @_selectedContactForAssign.FileAs</strong>
                </p>

                <div class="mb-3">
                    <img src="@_selectedImageForAssign.ImageUrl" class="img-fluid" />
                </div>

                <div class="d-flex justify-content-end">
                    <button class="btn btn-secondary btn-sm me-2"
                            @onclick="CancelAssign">
                        Cancel
                    </button>
                    <button class="btn btn-primary btn-sm"
                            @onclick="ConfirmAssign">
                        Save
                    </button>
                </div>
            </div>
        </div>
    }
}